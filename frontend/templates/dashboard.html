{% extends "base.html" %}
{% block title %}Dashboard - KrishiSense{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">

  <!-- Top section: title + subtle intro -->
  <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
    <div>
      <h1 class="text-2xl md:text-3xl font-bold text-slate-50 flex items-center gap-2">
        Farmer Dashboard
        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-emerald-500/20 text-emerald-300 text-xs animate-pulse">
          ‚óè
        </span>
      </h1>
      <p class="text-sm text-slate-300 mt-1">
        Check real-time crop price predictions, compare mandis, and see weather-based advisories in one place.
      </p>
    </div>
    <div class="flex gap-2 text-xs text-slate-300">
      <div class="px-3 py-1 rounded-full bg-slate-900/70 border border-emerald-500/30">
        <span class="inline-block w-2 h-2 rounded-full bg-emerald-400 mr-1"></span>
        Live weather powered by OpenWeather
      </div>
      <div class="px-3 py-1 rounded-full bg-slate-900/70 border border-sky-500/30">
        ML model: RandomForest / XGBoost hybrid
      </div>
    </div>
  </div>

  <!-- Main 2-column layout -->
  <div class="grid lg:grid-cols-3 gap-6 items-start">
    <!-- Left: prediction panel (takes 2 cols) -->
    <div class="lg:col-span-2 space-y-4">

      <!-- Prediction form card -->
      <div class="bg-slate-900/80 border border-slate-700/80 rounded-3xl p-5 md:p-6 shadow-xl shadow-emerald-500/15 backdrop-blur-md
                  transition-all duration-300 hover:shadow-emerald-500/25 hover:-translate-y-0.5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
          <h2 class="text-lg md:text-xl font-semibold tracking-tight">Get Price Prediction</h2>
          <div class="flex items-center gap-2 text-xs text-slate-300">
          </div>
        </div>

        <form id="predict-form" class="space-y-4">
          <div class="grid md:grid-cols-3 gap-3">
            <!-- Crop -->
            <div class="space-y-1">
              <label class="text-xs uppercase tracking-wide text-slate-400">Crop</label>
              <!-- options are filled dynamically by main.js -->
              <select id="crop-select" name="crop"
                      class="w-full rounded-2xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
              </select>
            </div>

            <!-- Market -->
            <div class="space-y-1">
              <label class="text-xs uppercase tracking-wide text-slate-400">Market / District</label>
              <select id="market-select" name="market"
                      class="w-full rounded-2xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
                <option>Kolkata</option>
                <option>Howrah</option>
                <option>Hooghly</option>
                <option>Nadia</option>
                <option>North 24 Parganas</option>
                <option>South 24 Parganas</option>
                <option>Purba Medinipur</option>
                <option>Paschim Medinipur</option>
                <option>Jhargram</option>
                <option>Bankura</option>
                <option>Birbhum</option>
                <option>Purba Bardhaman</option>
                <option>Paschim Bardhaman</option>
                <option>Murshidabad</option>
                <option>Malda</option>
                <option>Dakshin Dinajpur</option>
                <option>Uttar Dinajpur</option>
                <option>Alipurduar</option>
                <option>Cooch Behar</option>
                <option>Jalpaiguri</option>
                <option>Darjeeling</option>
                <option>Kalimpong</option>
                <option>Purulia</option>
              </select>
              <!-- üîπ NEW: hint text about valid crops for this market -->
              <p id="market-crop-hint" class="text-[11px] text-slate-400 mt-1"></p>
            </div>

            <!-- Date -->
            <div class="space-y-1">
              <label class="text-xs uppercase tracking-wide text-slate-400">Intended Selling Date</label>
              <div class="relative">
                <input id="date-input" name="date" type="date" placeholder="dd-mm-yyyy"
                       class="w-full rounded-2xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
                <span class="absolute inset-y-0 right-3 flex items-center text-slate-500 text-xs">üìÖ</span>
              </div>
            </div>
          </div>

          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mt-2">
            <label class="inline-flex items-center gap-2 text-xs text-slate-300 cursor-pointer">
              <input id="use-gps" type="checkbox"
                     class="rounded border-slate-600 bg-slate-900 text-emerald-500 focus:ring-emerald-500/70">
              <span>Use device location to auto-detect nearest market and weather</span>
            </label>

            <button type="submit"
                    class="inline-flex items-center justify-center px-6 py-2 rounded-2xl bg-emerald-500 text-slate-900 text-sm font-semibold
                           shadow-lg shadow-emerald-500/30 hover:bg-emerald-400 transition-all duration-200 hover:-translate-y-0.5">
              <span class="mr-1">Predict Price</span> ‚ö°
            </button>
          </div>
        </form>

        <!-- Prediction result -->
        <div id="prediction-result" class="mt-6 pt-4 border-t border-slate-800 hidden space-y-4">
          <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
            <div>
              <p class="text-xs uppercase tracking-wide text-slate-400 mb-1">Prediction Result</p>
              <div class="flex items-baseline gap-2">
                <p class="text-3xl md:text-4xl font-bold text-emerald-400 flex items-center gap-2">
                  <span id="predicted-price">--</span> <span class="text-lg">‚Çπ/kg</span>
                  <span id="trend-icon" class="text-2xl">‚ûñ</span>
                </p>
              </div>
              <p class="text-xs text-slate-300 mt-1">
                Likely range: <span id="confidence-range" class="font-semibold text-slate-100"></span> ‚Çπ/kg
              </p>
              <p id="best-day-text" class="text-[11px] text-slate-300 mt-1"></p>
            </div>
            <div class="md:text-right text-sm text-slate-200 max-w-md">
              <p id="advice-text"></p>
            </div>
          </div>

          <!-- Info grid -->
          <div class="grid xl:grid-cols-3 gap-3 mt-2">
            <!-- Current Weather (kept IDs for JS) -->
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-3 relative overflow-hidden
                        border border-slate-700/70 shadow-inner">
              <div class="absolute -right-10 -top-10 w-28 h-28 rounded-full bg-emerald-500/10 blur-2xl"></div>
              <p class="text-xs uppercase tracking-wide text-slate-400 mb-2 flex items-center gap-1">
                <span class="text-lg">‚òÅÔ∏è</span> Current Weather
              </p>

              <div class="flex items-end gap-2 mt-1">
                <span id="weather-temp" class="text-3xl font-bold text-emerald-400">--</span>
                <span class="text-sm text-slate-200 mb-1">¬∞C</span>
              </div>

              <p id="weather-condition" class="text-xs text-slate-300 mt-1">‚Äì</p>

              <div class="grid grid-cols-3 gap-2 mt-3 text-[11px]">
                <div class="bg-slate-900/70 rounded-xl px-2 py-1">
                  <div class="text-[10px] text-slate-400">Humidity</div>
                  <div id="weather-humidity" class="font-semibold text-slate-100">-- %</div>
                </div>
                <div class="bg-slate-900/70 rounded-xl px-2 py-1">
                  <div class="text-[10px] text-slate-400">Rainfall</div>
                  <div id="weather-rain" class="font-semibold text-slate-100">-- mm</div>
                </div>
                <div class="bg-slate-900/70 rounded-xl px-2 py-1">
                  <div class="text-[10px] text-slate-400">Feels like</div>
                  <div id="weather-feels" class="font-semibold text-slate-100">-- ¬∞C</div>
                </div>
              </div>
            </div>

            <!-- Upcoming weather -->
            <div class="bg-slate-900/80 rounded-2xl p-3 border border-slate-700/60">
              <p class="text-xs uppercase tracking-wide text-slate-400 mb-2 flex items-center gap-1">
                <span class="text-lg">üìÖ</span> Upcoming Weather (5 days)
              </p>
              <ul id="forecast-info" class="space-y-1 text-[11px] text-slate-200"></ul>
            </div>

            <!-- Agro advisory -->
            <div class="bg-slate-900/80 rounded-2xl p-3 border border-slate-700/60">
              <div class="flex items-center justify-between mb-1">
                <p class="text-xs uppercase tracking-wide text-slate-400 flex items-center gap-1">
                  <span class="text-lg">üå±</span> Agro Advisory
                </p>
                <span id="suitability-badge"
                      class="text-[11px] px-2 py-0.5 rounded-full border border-slate-500 capitalize">
                </span>
              </div>
              <p id="suitability-text" class="text-[11px] text-slate-200 mb-1"></p>
              <p id="disease-risk" class="text-[11px] text-slate-200 mb-1"></p>
              <p id="extreme-warning" class="text-[11px] text-slate-200"></p>
            </div>
          </div>

          <!-- Second row: market comparison + explanation -->
          <div class="grid lg:grid-cols-2 gap-3 mt-3">
            <div class="bg-slate-900/80 rounded-2xl p-3 border border-slate-700/60">
              <p class="text-xs uppercase tracking-wide text-slate-400 mb-2 flex items-center gap-1">
                <span class="text-lg">üìç</span> Nearby Market Comparison
              </p>
              <ul id="alternative-markets" class="space-y-1 text-xs text-slate-200"></ul>
            </div>

            <div class="bg-slate-900/80 rounded-2xl p-3 border border-slate-700/60">
              <p class="text-xs uppercase tracking-wide text-slate-400 mb-2 flex items-center gap-1">
                <span class="text-lg">üîç</span> Why this price?
              </p>
              <ul id="feature-summary"
                  class="space-y-1 text-xs text-slate-200 list-disc list-inside"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: history panel -->
    <div class="space-y-4">
      <div class="bg-slate-900/80 border border-slate-700/80 rounded-3xl p-4 md:p-5 shadow-xl shadow-sky-500/10 backdrop-blur-md
                  transition-all duration-300 hover:shadow-sky-500/20 hover:-translate-y-0.5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Recent Predictions</h2>
        </div>

        <div id="history-list" class="space-y-3 text-xs max-h-[220px] overflow-y-auto pr-1 mb-4 custom-scroll"></div>

        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-semibold">Price Trend <span class="text-[11px text-slate-400">(History)</span></h3>
          <div class="flex gap-2 text-[11px]">
            <select id="history-filter-crop"
                    class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700">
              <option value="">All Crops</option>
            </select>
            <select id="history-filter-market"
                    class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700">
              <option value="">All Markets</option>
            </select>
          </div>
        </div>
        <div class="bg-slate-950/60 rounded-2xl px-3 py-2 border border-slate-800">
          <canvas id="history-chart" height="140"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom: district snapshot -->
  <div class="bg-slate-900/80 border border-slate-700/80 rounded-3xl p-5 md:p-6 shadow-xl shadow-emerald-500/10 backdrop-blur-md
              transition-all duration-300 hover:shadow-emerald-500/20 hover:-translate-y-0.5">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-2">
      <div>
        <h2 class="text-lg md:text-xl font-semibold">District-wise Price Snapshot (Last 7 days)</h2>
        <p class="text-xs text-slate-300">
          <span class="text-emerald-400 font-semibold">High</span> prices ‚Ä¢
          <span class="text-slate-200"> Medium</span> ‚Ä¢
          <span class="text-yellow-300"> Low</span>
        </p>
      </div>
      <div class="flex items-center gap-2 text-xs">
        <span class="text-slate-300">Filter crop:</span>
        <select id="heatmap-crop"
                class="px-3 py-1 rounded-xl bg-slate-900 border border-slate-700 text-xs">
          <option value="">All Crops</option>
          <option>Rice</option>
          <option>Potato</option>
          <option>Jute</option>
          <option>Tea</option>
          <option>Oilseeds</option>
          <option>Pulses</option>
          <option>Maize</option>
          <option>Banana</option>
          <option>Vegetables</option>
          <option>Litchi</option>
          <option>Mango</option>
          <option>Sugarcane</option>
          <option>Pineapple</option>
          <option>Wheat</option>
        </select>
      </div>
    </div>

    <div id="top5-table" class="text-xs text-slate-200 mb-3"></div>

    <div id="heatmap-grid" class="grid sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 text-sm"></div>
  </div>
</div>
{% endblock %}
